name: Forex AI Analysis

on:
  schedule:
    # Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± 2 Ø³Ø§Ø¹Øª Ø¯Ø± Ø³Ø§Ø¹Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÙˆØ¬
    - cron: '0 */2 * * *'
    # Ø§Ø¬Ø±Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¯Ø± Ø³Ø§Ø¹Øª 8 ØµØ¨Ø­ Ø¨Ù‡ ÙˆÙ‚Øª UTC
    - cron: '0 8 * * *'
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
    inputs:
      pairs:
        description: 'Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)'
        required: false
        default: 'EUR/USD,GBP/USD,USD/JPY'
      all_pairs:
        description: 'ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'
  OUTPUT_DIR: 'results'
  
permissions:
  contents: write
  issues: write
  pull-requests: write
  
jobs:
  forex-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write
      issues: write
      
    strategy:
      matrix:
        python-version: [3.12]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip build-essential jq
        
    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai pandas pandas-ta aiohttp asyncio python-dotenv requests
        
    - name: Create results directory
      run: mkdir -p ${{ env.OUTPUT_DIR }}
      
    - name: Run Flexible Forex AI Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
        CLOUDFLARE_AI_API_KEY: ${{ secrets.CLOUDFLARE_AI_API_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        echo "ðŸ”„ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±..."
        echo "ðŸ“Š ÙˆØ¶Ø¹ÛŒØª APIÙ‡Ø§: Gemini, Cloudflare, Groq"
        
        # ØªØ¹ÛŒÛŒÙ† Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ
        if [ "${{ github.event.inputs.all_pairs }}" = "true" ]; then
          echo "ðŸ” ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§"
          python flexible_forex_ai.py --all
        elif [ -n "${{ github.event.inputs.pairs }}" ]; then
          echo "ðŸ” ØªØ­Ù„ÛŒÙ„ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡: ${{ github.event.inputs.pairs }}"
          python flexible_forex_ai.py --pairs "${{ github.event.inputs.pairs }}"
        else
          echo "ðŸ” ØªØ­Ù„ÛŒÙ„ Û² Ø¬ÙØª Ø§Ø±Ø² Ø§ØµÙ„ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶"
          python flexible_forex_ai.py
        fi
        
        echo "âœ… ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø´Ø¯"
        
    - name: Archive results
      uses: actions/upload-artifact@v4
      with:
        name: forex-signals-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          strong_consensus_signals.json
          medium_consensus_signals.json
          weak_consensus_signals.json
          trading_log.log
          signal_cache.json
          api_usage_tracker.json
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload results to workflow summary
      run: |
        echo "# ðŸŽ¯ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ AI Ù‡ÙˆØ´Ù…Ù†Ø¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù API
        if [ -f "api_usage_tracker.json" ]; then
          echo "## ðŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù APIÙ‡Ø§" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat api_usage_tracker.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
        if [ -f "strong_consensus_signals.json" ] && [ -s "strong_consensus_signals.json" ]; then
          STRONG_COUNT=$(jq length strong_consensus_signals.json)
          echo "## ðŸŽ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: $STRONG_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **Ø³Ø·Ø­ ÙˆØ±ÙˆØ¯:** \(.ENTRY_ZONE)\n- **Ø­Ø¯ Ø¶Ø±Ø±:** \(.STOP_LOSS)\n- **Ø­Ø¯ Ø³ÙˆØ¯:** \(.TAKE_PROFIT)\n- **Ù†Ø³Ø¨Øª Ø³ÙˆØ¯ Ø¨Ù‡ Ø²ÛŒØ§Ù†:** \(.RISK_REWARD_RATIO)\n- **Ø§Ù†Ù‚Ø¶Ø§:** \(.EXPIRATION_H) Ø³Ø§Ø¹Øª\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n- **Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§ÙÙ‚:** \(.VALID_MODELS) Ø§Ø² \(.TOTAL_MODELS)\n\n"' strong_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸŽ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "medium_consensus_signals.json" ] && [ -s "medium_consensus_signals.json" ]; then
          MEDIUM_COUNT=$(jq length medium_consensus_signals.json)
          echo "## ðŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: $MEDIUM_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n\n"' medium_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "weak_consensus_signals.json" ] && [ -s "weak_consensus_signals.json" ]; then
          WEAK_COUNT=$(jq length weak_consensus_signals.json)
          echo "## ðŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: $WEAK_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n\n"' weak_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¤– *ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±*" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ *Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± APIÙ‡Ø§: Gemini, Cloudflare, Groq*" >> $GITHUB_STEP_SUMMARY

    - name: Commit and Push Results to Repository
      run: |
        # Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
        if git diff --name-only | grep -E '(strong_consensus_signals|medium_consensus_signals|weak_consensus_signals|api_usage_tracker)\.json'; then
          echo "ðŸ”„ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
          git add strong_consensus_signals.json medium_consensus_signals.json weak_consensus_signals.json api_usage_tracker.json trading_log.log
          
          # Ø§ÛŒØ¬Ø§Ø¯ commit
          git commit -m "ðŸ“ˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ú©Ø³ - $(date +'%Y-%m-%d %H:%M')"
          
          # push ØªØºÛŒÛŒØ±Ø§Øª
          git push
          
          echo "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø±ÛŒÙ¾Ùˆ push Ø´Ø¯Ù†Ø¯"
        else
          echo "ðŸ” Ù‡ÛŒÚ† ØªØºÛŒÛŒØ± Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ÛŒ Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
        fi
        
    - name: Send success notification
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let message = 'âœ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\\n\\n';
          let hasSignals = false;
          
          // Ø®ÙˆØ§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù API
          try {
            if (fs.existsSync('api_usage_tracker.json')) {
              const apiUsage = JSON.parse(fs.readFileSync('api_usage_tracker.json', 'utf8'));
              message += 'ðŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù API:**\\n';
              for (const [provider, data] of Object.entries(apiUsage.providers)) {
                const remaining = data.limit - data.used_today;
                message += `â€¢ ${provider}: ${data.used_today}/${data.limit} (${remaining} Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡)\\n`;
              }
              message += '\\n';
            }
          } catch (error) {
            console.log('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª API:', error);
          }
          
          // Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
          try {
            if (fs.existsSync('strong_consensus_signals.json')) {
              const strongSignals = JSON.parse(fs.readFileSync('strong_consensus_signals.json', 'utf8'));
              if (strongSignals.length > 0) {
                hasSignals = true;
                message += `ðŸŽ¯ **Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆÛŒ:** ${strongSignals.length}\\n`;
                strongSignals.forEach(signal => {
                  const actionIcon = signal.ACTION === 'BUY' ? 'ðŸŸ¢' : signal.ACTION === 'SELL' ? 'ðŸ”´' : 'âšª';
                  message += `${actionIcon} ${signal.SYMBOL} - ${signal.ACTION} (Ø§Ø¹ØªÙ…Ø§Ø¯: ${signal.CONFIDENCE}/10, ØªÙˆØ§ÙÙ‚: ${signal.AGREEMENT_LEVEL}/${signal.TOTAL_MODELS})\\n`;
                });
                message += '\\n';
              }
            }
            
            if (fs.existsSync('medium_consensus_signals.json')) {
              const mediumSignals = JSON.parse(fs.readFileSync('medium_consensus_signals.json', 'utf8'));
              if (mediumSignals.length > 0) {
                hasSignals = true;
                message += `ðŸ“Š **Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…ØªÙˆØ³Ø·:** ${mediumSignals.length}\\n`;
                mediumSignals.forEach(signal => {
                  const actionIcon = signal.ACTION === 'BUY' ? 'ðŸŸ¢' : signal.ACTION === 'SELL' ? 'ðŸ”´' : 'âšª';
                  message += `${actionIcon} ${signal.SYMBOL} - ${signal.ACTION} (Ø§Ø¹ØªÙ…Ø§Ø¯: ${signal.CONFIDENCE}/10)\\n`;
                });
                message += '\\n';
              }
            }
            
            if (fs.existsSync('weak_consensus_signals.json')) {
              const weakSignals = JSON.parse(fs.readFileSync('weak_consensus_signals.json', 'utf8'));
              if (weakSignals.length > 0) {
                hasSignals = true;
                message += `ðŸ“ˆ **Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¶Ø¹ÛŒÙ:** ${weakSignals.length}\\n`;
                weakSignals.forEach(signal => {
                  const actionIcon = signal.ACTION === 'BUY' ? 'ðŸŸ¢' : signal.ACTION === 'SELL' ? 'ðŸ”´' : 'âšª';
                  message += `${actionIcon} ${signal.SYMBOL} - ${signal.ACTION}\\n`;
                });
              }
            }
            
            if (!hasSignals) {
              message += 'ðŸ” **Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒâ€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯**\\n';
            }
            
          } catch (error) {
            message += 'ðŸ“ **Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù†ØªØ§ÛŒØ¬**\\n';
            console.log('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§:', error);
          }
          
          // Ø§ÛŒØ¬Ø§Ø¯ issue Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸ“ˆ Ú¯Ø²Ø§Ø±Ø´ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ - ${new Date().toISOString().split('T')[0]}`,
            body: message,
            labels: ['forex-analysis', 'automated']
          });

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Cleanup old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const now = Date.now();
          const retentionDays = 7; // Ø­Ø°Ù Ø¢Ø±ØªÛŒÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² 7 Ø±ÙˆØ²
          const retentionTime = retentionDays * 24 * 60 * 60 * 1000;
          
          for (const artifact of artifacts.artifacts) {
            const createdAt = new Date(artifact.created_at).getTime();
            if (now - createdAt > retentionTime) {
              console.log(`Deleting old artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
          }
