# .github/workflows/main.yml

name: Get Gemini Trade Signal

on:
  # اجرای خودکار هر 2 ساعت یکبار
  schedule:
    - cron: '0 */2 * * *'

  # این گزینه به شما اجازه می‌دهد که Workflow را به صورت دستی هم از طریق تب Actions در گیت‌هاب اجرا کنید
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # این مجوز برای اینکه Action بتواند در ریپازیتوری شما بنویسد، ضروری است
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5 # فقط شماره نسخه به روز شد
        with:
          python-version: '3.12'
        
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pandas pandas-ta aiohttp requests TA-Lib

      - name: Run Gemini Trader Script
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
          CLOUDFLARE_AI_API_KEY: ${{ secrets.CLOUDFLARE_AI_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: python gemini_trader.py --all

      # مرحله کامیت کردن فایل با کد خودتان (فقط نام فایل اصلاح شد)
      - name: Commit trade signal file
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          # --- تنها تغییر اصلی اینجا بود ---
          git add hybrid_ai_signals.json signal_cache.json trading_log.log
          # فقط در صورتی که تغییری وجود داشته باشد، کامیت کن
          git diff --staged --quiet || git commit -m "Auto-update trade signals"
          git push
