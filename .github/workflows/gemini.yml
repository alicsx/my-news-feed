name: Forex AI Analysis

on:
  schedule:
    # Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± 2 Ø³Ø§Ø¹Øª Ø¯Ø± Ø³Ø§Ø¹Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÙˆØ¬
    - cron: '0 */2 * * *'
    # Ø§Ø¬Ø±Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¯Ø± Ø³Ø§Ø¹Øª 8 ØµØ¨Ø­ Ø¨Ù‡ ÙˆÙ‚Øª UTC
    - cron: '0 8 * * *'
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
    inputs:
      pairs:
        description: 'Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)'
        required: false
        default: 'EUR/USD,GBP/USD,USD/JPY,USD/CHF,AUD/USD'
      all_pairs:
        description: 'ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§'
        required: false
        type: boolean
        default: false
      analysis_type:
        description: 'Ù†ÙˆØ¹ ØªØ­Ù„ÛŒÙ„'
        required: false
        type: choice
        options:
        - 'standard'
        - 'deep'
        - 'quick'
        default: 'standard'

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_DIR: 'results'

jobs:
  forex-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        python-version: [3.11]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip build-essential
        
    - name: Cache Python packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai pandas pandas-ta aiohttp asyncio python-dotenv requests jq 
        
    - name: Create results directory
      run: mkdir -p ${{ env.OUTPUT_DIR }}
      
    - name: Run Forex AI Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
        CLOUDFLARE_AI_API_KEY: ${{ secrets.CLOUDFLARE_AI_API_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        echo "ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ú†Ù‡Ø§Ø±Ú¯Ø§Ù†Ù‡..."
        
        # ØªØ¹ÛŒÛŒÙ† Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ
        if [ "${{ github.event.inputs.all_pairs }}" = "true" ]; then
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§"
          python forex_ai_analyzer.py --all
        elif [ -n "${{ github.event.inputs.pairs }}" ]; then
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡: ${{ github.event.inputs.pairs }}"
          python forex_ai_analyzer.py --pairs "${{ github.event.inputs.pairs }}"
        else
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Ûµ Ø¬ÙØª Ø§Ø±Ø² Ø§ØµÙ„ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶"
          python forex_ai_analyzer.py
        fi
        
        echo "âœ… ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø´Ø¯"
        
    - name: Archive results
      uses: actions/upload-artifact@v4
      with:
        name: forex-signals-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          strong_consensus_signals.json
          medium_consensus_signals.json
          weak_consensus_signals.json
          trading_log.log
          signal_cache.json
        retention-days: 30
        if-no-files-found: error
        
    - name: Upload results to workflow summary
      run: |
        echo "# ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ AI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
        if [ -f "strong_consensus_signals.json" ]; then
          STRONG_COUNT=$(jq length strong_consensus_signals.json)
          echo "## ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: $STRONG_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/4\n- **Ø³Ø·Ø­ ÙˆØ±ÙˆØ¯:** \(.ENTRY_ZONE)\n- **Ø­Ø¯ Ø¶Ø±Ø±:** \(.STOP_LOSS)\n- **Ø­Ø¯ Ø³ÙˆØ¯ Û±:** \(.TAKE_PROFIT_1)\n- **Ù†Ø³Ø¨Øª Ø³ÙˆØ¯ Ø¨Ù‡ Ø²ÛŒØ§Ù†:** \(.RISK_REWARD_RATIO)\n- **Ø§Ù†Ù‚Ø¶Ø§:** \(.EXPIRATION_H) Ø³Ø§Ø¹Øª\n- **Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡:** \(.TRADE_TYPE)\n- **Ø§Ù…ØªÛŒØ§Ø² ÙÙ†ÛŒ:** \(.TECHNICAL_SCORE)/100\n\n"' strong_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "medium_consensus_signals.json" ]; then
          MEDIUM_COUNT=$(jq length medium_consensus_signals.json)
          echo "## ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: $MEDIUM_COUNT" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "weak_consensus_signals.json" ]; then
          WEAK_COUNT=$(jq length weak_consensus_signals.json)
          echo "## ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: $WEAK_COUNT" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– *ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ú†Ù‡Ø§Ø±Ú¯Ø§Ù†Ù‡*" >> $GITHUB_STEP_SUMMARY
        
    - name: Send success notification
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let message = 'âœ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\\n\\n';
          
          // Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
          try {
            if (fs.existsSync('strong_consensus_signals.json')) {
              const strongSignals = JSON.parse(fs.readFileSync('strong_consensus_signals.json', 'utf8'));
              message += `ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆÛŒ: ${strongSignals.length}\\n`;
              
              strongSignals.forEach(signal => {
                message += `â€¢ ${signal.SYMBOL} - ${signal.ACTION} (Ø§Ø¹ØªÙ…Ø§Ø¯: ${signal.CONFIDENCE}/10)\\n`;
              });
            }
            
            if (fs.existsSync('medium_consensus_signals.json')) {
              const mediumSignals = JSON.parse(fs.readFileSync('medium_consensus_signals.json', 'utf8'));
              message += `ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…ØªÙˆØ³Ø·: ${mediumSignals.length}\\n`;
            }
            
            if (fs.existsSync('weak_consensus_signals.json')) {
              const weakSignals = JSON.parse(fs.readFileSync('weak_consensus_signals.json', 'utf8'));
              message += `ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¶Ø¹ÛŒÙ: ${weakSignals.length}\\n`;
            }
            
            if (message === 'âœ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\\n\\n') {
              message += 'ğŸ” Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒâ€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯';
            }
            
          } catch (error) {
            message += 'ğŸ“ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù†ØªØ§ÛŒØ¬';
          }
          
          // Ø§ÛŒØ¬Ø§Ø¯ issue Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ - ${new Date().toLocaleDateString('fa-IR')}`,
            body: message,
            labels: ['forex-analysis', 'automated']
          });
          
    - name: Send failure notification
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³',
            body: `Workflow ${context.workflow} failed in run ${context.runId}`,
            labels: ['forex-analysis', 'failure']
          });

  deploy-results:
    needs: forex-analysis
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download analysis results
      uses: actions/download-artifact@v4
      with:
        pattern: forex-signals-*
        path: ./results
        
    - name: List downloaded files
      run: ls -la ./results/
      
    - name: Deploy to GitHub Pages (Optional)
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./results
        keep_files: true
        publish_branch: gh-pages
        force_orphan: false
        commit_message: 'ğŸ“ˆ Update Forex AI Signals - ${{ github.run_id }}'
