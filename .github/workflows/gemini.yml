# .github/workflows/main.yml

name: Run Hybrid AI Forex Analyzer

on:
  # اجرای خودکار هر 2 ساعت یکبار
  # برای تغییر زمان‌بندی از سایت crontab.guru کمک بگیرید
  schedule:
    - cron: '0 */2 * * *'

  # این گزینه به شما اجازه می‌دهد که Workflow را به صورت دستی هم از طریق تب Actions در گیت‌هاب اجرا کنید
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # این مجوز برای کامیت کردن فایل‌ها در ریپازیتوری ضروری است
    permissions:
      contents: write
    
    steps:
      # مرحله ۱: دانلود کد ریپازیتوری
      - name: Checkout repository
        uses: actions/checkout@v4

      # مرحله ۲: نصب پایتون
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # مرحله ۳: نصب پیش‌نیاز کتابخانه TA-Lib
      # این کتابخانه به یک پیش‌نیاز سیستمی نیاز دارد که باید قبل از نصب پکیج پایتون، نصب شود
      - name: Install TA-Lib C-library
        run: sudo apt-get update && sudo apt-get install -y ta-lib-dev

      # مرحله ۴: نصب کتابخانه‌های پایتون
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pandas pandas-ta aiohttp requests TA-Lib

      # مرحله ۵: اجرای اسکریپت تحلیل‌گر
      # با استفاده از --all، اسکریپت تمام جفت‌ارزهای تعریف شده را تحلیل می‌کند
      - name: Run Hybrid AI Trader Script
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
          CLOUDFLARE_AI_API_KEY: ${{ secrets.CLOUDFLARE_AI_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: python gemini_trader.py --all

      # مرحله ۶: کامیت و پوش کردن فایل‌های خروجی در ریپازیتوری
      # این بخش فایل‌های تولید شده را به صورت خودکار در گیت‌هاب شما آپدیت می‌کند
      - name: Commit and Push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update trade signals and logs"
          # فایل‌هایی که می‌خواهید ذخیره شوند را اینجا مشخص کنید
          file_pattern: "hybrid_ai_signals.json signal_cache.json trading_log.log"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions Bot <actions@github.com>"
