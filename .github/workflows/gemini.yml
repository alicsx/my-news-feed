name: Forex AI Analysis

on:
  schedule:
    - cron: '0 */2 * * *'
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      pairs:
        description: 'Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)'
        required: false
        default: 'EUR/USD,GBP/USD,USD/JPY'
      all_pairs:
        description: 'ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'
  
permissions:
  contents: write
  issues: write
  
jobs:
  forex-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip build-essential jq
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai pandas pandas-ta aiohttp asyncio python-dotenv requests
        
    - name: Run Flexible Forex AI Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
        CLOUDFLARE_AI_API_KEY: ${{ secrets.CLOUDFLARE_AI_API_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        echo "ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±..."
        
        # ØªØ¹ÛŒÛŒÙ† Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ
        if [ "${{ github.event.inputs.all_pairs }}" = "true" ]; then
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Ù‡Ù…Ù‡ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§"
          python flexible_forex_ai.py --all
        elif [ -n "${{ github.event.inputs.pairs }}" ]; then
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡: ${{ github.event.inputs.pairs }}"
          python flexible_forex_ai.py --pairs "${{ github.event.inputs.pairs }}"
        else
          echo "ğŸ” ØªØ­Ù„ÛŒÙ„ Û² Ø¬ÙØª Ø§Ø±Ø² Ø§ØµÙ„ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶"
          python flexible_forex_ai.py
        fi
        
        echo "âœ… ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø´Ø¯"
        echo "ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡:"
        ls -la *.json *.log || echo "ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯"
        
    - name: Commit and Push Results to Repository
      run: |
        echo "ğŸ“Š Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± root:"
        ls -la *.json *.log 2>/dev/null || echo "âš ï¸ ÙØ§ÛŒÙ„ JSON ÛŒØ§ LOG ÛŒØ§ÙØª Ù†Ø´Ø¯"
        
        # Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ù„Ø§Ú¯
        git add *.json *.log 2>/dev/null || true
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
        if git status --porcelain | grep -E '\.(json|log)$'; then
          echo "ğŸ”„ ØªØºÛŒÛŒØ±Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯:"
          git status --porcelain
          
          # Ø§ÛŒØ¬Ø§Ø¯ commit
          git commit -m "ğŸ“ˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ú©Ø³ - $(date +'%Y-%m-%d %H:%M UTC')"
          
          # push ØªØºÛŒÛŒØ±Ø§Øª
          git push
          echo "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø±ÛŒÙ¾Ùˆ push Ø´Ø¯Ù†Ø¯"
        else
          echo "ğŸ” Ù‡ÛŒÚ† ØªØºÛŒÛŒØ± Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ÛŒ Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
        fi
        
    - name: Upload results to workflow summary
      run: |
        echo "# ğŸ¯ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ AI Ù‡ÙˆØ´Ù…Ù†Ø¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
        echo "## ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la *.json *.log 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù API
        if [ -f "api_usage_tracker.json" ]; then
          echo "## ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù APIÙ‡Ø§" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat api_usage_tracker.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Ù†Ù…Ø§ÛŒØ´ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§
        if [ -f "medium_consensus_signals.json" ] && [ -s "medium_consensus_signals.json" ]; then
          MEDIUM_COUNT=$(jq length medium_consensus_signals.json)
          echo "## ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: $MEDIUM_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n\n"' medium_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù…ØªÙˆØ³Ø·: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "strong_consensus_signals.json" ] && [ -s "strong_consensus_signals.json" ]; then
          STRONG_COUNT=$(jq length strong_consensus_signals.json)
          echo "## ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: $STRONG_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n\n"' strong_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ù‚ÙˆÛŒ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "weak_consensus_signals.json" ] && [ -s "weak_consensus_signals.json" ]; then
          WEAK_COUNT=$(jq length weak_consensus_signals.json)
          echo "## ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: $WEAK_COUNT" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "### \(.SYMBOL) - \(.ACTION) \n- **Ø§Ø¹ØªÙ…Ø§Ø¯:** \(.CONFIDENCE)/10\n- **ØªÙˆØ§ÙÙ‚:** \(.AGREEMENT_LEVEL)/\(.TOTAL_MODELS)\n- **ØªØ­Ù„ÛŒÙ„:** \(.ANALYSIS)\n\n"' weak_consensus_signals.json >> $GITHUB_STEP_SUMMARY
        else
          echo "## ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ØªÙˆØ§ÙÙ‚ Ø¶Ø¹ÛŒÙ: Û°" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– *ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ… ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ Ø¨Ø§ AI Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±*" >> $GITHUB_STEP_SUMMARY

    - name: Create Issue with Results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let message = '## ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³\n\n';
          
          try {
            // Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
            const files = ['strong_consensus_signals.json', 'medium_consensus_signals.json', 'weak_consensus_signals.json'];
            let hasSignals = false;
            
            for (const file of files) {
              if (fs.existsSync(file)) {
                const signals = JSON.parse(fs.readFileSync(file, 'utf8'));
                if (signals.length > 0) {
                  hasSignals = true;
                  const type = file.includes('strong') ? 'Ù‚ÙˆÛŒ' : file.includes('medium') ? 'Ù…ØªÙˆØ³Ø·' : 'Ø¶Ø¹ÛŒÙ';
                  message += `### ğŸ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ${type}: ${signals.length}\n`;
                  
                  signals.forEach(signal => {
                    const icon = signal.ACTION === 'BUY' ? 'ğŸŸ¢' : signal.ACTION === 'SELL' ? 'ğŸ”´' : 'âšª';
                    message += `${icon} **${signal.SYMBOL}** - ${signal.ACTION} (Ø§Ø¹ØªÙ…Ø§Ø¯: ${signal.CONFIDENCE}/10)\n`;
                    message += `   - ØªÙˆØ§ÙÙ‚: ${signal.AGREEMENT_LEVEL}/${signal.TOTAL_MODELS}\n`;
                    message += `   - ØªØ­Ù„ÛŒÙ„: ${signal.ANALYSIS || 'Ù†Ø¯Ø§Ø±Ø¯'}\n\n`;
                  });
                }
              }
            }
            
            if (!hasSignals) {
              message += 'ğŸ” Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒâ€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯\n\n';
            }
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª API
            if (fs.existsSync('api_usage_tracker.json')) {
              const apiUsage = JSON.parse(fs.readFileSync('api_usage_tracker.json', 'utf8'));
              message += '### ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù…ØµØ±Ù API\n';
              message += '```json\n' + JSON.stringify(apiUsage, null, 2) + '\n```\n';
            }
            
          } catch (error) {
            message += 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù†ØªØ§ÛŒØ¬\n';
            console.error('Error:', error);
          }
          
          // Ø§ÛŒØ¬Ø§Ø¯ issue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ - ${new Date().toISOString().split('T')[0]}`,
            body: message,
            labels: ['forex-analysis', 'automated']
          });
